#ğŸ”¹ Windows Internals â€“ Portable Executable (PE) Format & Memory Mapping
#Portable Executable (PE) Internals and Runtime Memory Mapping


ğŸ§© Portable Executable (PE) â€” Deep Windows Internals

Ø£ÙŠ Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø¹Ù„Ù‰ Windows:

.exe  |  .dll  |  .sys

ÙƒÙ„Ù‡Ù… ÙÙŠ Ø§Ù„Ø­Ù‚ÙŠÙ‚Ø©:

PE File

ğŸ“Œ ÙˆØ§Ù„Ù€ PE Ù…Ø´ Ù…Ø¬Ø±Ø¯ Ù…Ù„Ù
Ø¯Ù‡ Ø®Ø±ÙŠØ·Ø© ØªÙ†ÙÙŠØ° Ø¨ØªÙ‚ÙˆÙ„ Ù„Ù„ÙˆÙŠÙ†Ø¯ÙˆØ²:

Ø£Ø­Ø· Ø¥ÙŠÙ‡ ÙÙŠ Ø§Ù„Ø±Ø§Ù…

ÙÙŠÙ† Ø§Ù„ÙƒÙˆØ¯

ÙÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª

Ø£Ù†ÙÙ‘Ø° Ù…Ù†ÙŠÙ†


#ğŸ—‚ï¸ 1ï¸âƒ£ PE High-Level Structure

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DOS Header                   â”‚
â”‚ ("MZ")                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ DOS Stub                     â”‚
â”‚ ("This program cannot...")  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ NT Headers ("PE\0\0")        â”‚
â”‚  â”œâ”€ File Header              â”‚
â”‚  â””â”€ Optional Header âš ï¸       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Section Table                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Sections (.text, .data...)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

#ğŸ§± 2ï¸âƒ£ DOS Header (Legacy)
IMAGE_DOS_HEADER

    Ø£ÙˆÙ„ 64 Ø¨Ø§ÙŠØª

    Signature: MZ

    Ø£Ù‡Ù… field:

e_lfanew â†’ offset Ù„Ù„Ù€ PE Header



#ğŸ“Œ Ø§Ù„ÙˆÙŠÙ†Ø¯ÙˆØ² ÙŠÙ‚ÙØ² Ù…Ø¨Ø§Ø´Ø±Ø© Ù„Ù„Ù€ NT Header
#(Ø§Ù„Ø¨Ø§Ù‚ÙŠ ØªØ§Ø±ÙŠØ®)



ğŸ§  3ï¸âƒ£ NT Headers (Ù‚Ù„Ø¨ Ø§Ù„Ù€ PE)
PE\0\0

ÙŠØªÙƒÙˆÙ‘Ù† Ù…Ù†:
IMAGE_NT_HEADERS
 â”œâ”€ File Header
 â””â”€ Optional Header (Ù…Ø´ optional ÙØ¹Ù„ÙŠÙ‹Ø§)

#ğŸ“„ 4ï¸âƒ£ File Header
| Field            | ÙˆØ¸ÙŠÙØ©       |
| ---------------- | ----------- |
| Machine          | x86 / x64   |
| NumberOfSections | Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… |
| Characteristics  | DLLØŸ EXEØŸ   |

ğŸ“Œ Ù‡Ù†Ø§ Ø§Ù„ÙˆÙŠÙ†Ø¯ÙˆØ² ÙŠØ¹Ø±Ù:
Ø¯Ù‡ Ø¨Ø±Ù†Ø§Ù…Ø¬ ÙˆÙ„Ø§ Ù…ÙƒØªØ¨Ø©ØŸ

#ğŸ§¬ 5ï¸âƒ£ Optional Header (Ø§Ù„Ø£Ù‡Ù… ğŸ”¥)
#Ø¯Ù‡ Ø®Ø±ÙŠØ·Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙÙŠ Ø§Ù„Ø±Ø§Ù…
#ğŸ“Œ Ø¯Ù‡ Ø§Ù„Ù„ÙŠ ÙŠØ±Ø¨Ø· PE Ø¨Ø§Ù„Ù€ RAM Ù…Ø¨Ø§Ø´Ø±Ø©

| Field               | Ù…Ø¹Ù†Ù‰                     |
| ------------------- | ------------------------ |
| AddressOfEntryPoint | Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©             |
| ImageBase           | Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…ÙØ¶Ù‘Ù„ ÙÙŠ Ø§Ù„Ø±Ø§Ù… |
| SizeOfImage         | Ø­Ø¬Ù… Ø§Ù„Ø°Ø§ÙƒØ±Ø©              |
| SectionAlignment    | Ù…Ø­Ø§Ø°Ø§Ø© Ø§Ù„Ø±Ø§Ù…             |
| DataDirectory       | Import / Export / TLS    |


#ğŸšª 6ï¸âƒ£ Entry Point (EP)
#ÙŠØ¹Ù†ÙŠ
# Ø£ÙˆÙ„ ØªØ¹Ù„ÙŠÙ…Ø© CPU ÙŠÙ†ÙÙ‘Ø°Ù‡Ø§
# Ø¨Ø¹Ø¯ Load ÙƒÙ„ Ø´ÙŠØ¡
# ØºØ§Ù„Ø¨Ù‹Ø§:
#  EXE â†’ CRT startup
#  DLL â†’ DllMain
EntryPoint â†’ RVA

#ğŸ§± 7ï¸âƒ£ Sections (ØªÙ‚Ø³ÙŠÙ… Ø§Ù„ØªÙ†ÙÙŠØ°)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ .text    â”‚ .data    â”‚ .rdata   â”‚
â”‚ Code     â”‚ Variablesâ”‚ Constantsâ”‚
â”‚ RX       â”‚ RW       â”‚ R        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

#Ø£Ø´Ù‡Ø± Sections:
| Section | ÙˆØ¸ÙŠÙØ©           |
| ------- | --------------- |
| .text   | Ø§Ù„ÙƒÙˆØ¯           |
| .data   | Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªØºÙŠØ±Ø©   |
| .rdata  | Strings / Const |
| .bss    | Ø¨ÙŠØ§Ù†Ø§Øª ØµÙØ±ÙŠØ©    |
| .idata  | Imports         |
| .edata  | Exports         |
| .rsrc   | Resources       |
| .reloc  | Relocation      |

#ğŸ“Œ Permissions Ù…Ù‡Ù…Ø© Ø¬Ø¯Ù‹Ø§ ğŸ‘‡

#ğŸ” 8ï¸âƒ£ Sections â†’ RAM Permissions
Section        RAM Permission
--------------------------------
.text          READ + EXECUTE
.data          READ + WRITE
.rdata         READ



ğŸš¨ Ø£ÙŠ Ø®Ù„Ù„:

    Code ÙÙŠ RW

    Data ÙÙŠ RX
    â†’ Ø³Ù„ÙˆÙƒ ØºÙŠØ± Ø·Ø¨ÙŠØ¹ÙŠ


#ğŸ”— 9ï¸âƒ£ Import Table (Ø±Ø¨Ø· Ø§Ù„Ù†Ø¸Ø§Ù…)
kernel32.dll
 â”œâ”€ CreateFileA
 â”œâ”€ VirtualAlloc
 â”œâ”€ ReadFile


#ğŸ“Œ Ø§Ù„ÙˆÙŠÙ†Ø¯ÙˆØ²
1- ÙŠØ­Ù…Ù‘Ù„ DLL
2- ÙŠØ±Ø¨Ø· Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†
3- ÙŠØ­Ø·Ù‡Ø§ ÙÙŠ IAT

#ğŸ”„ 1ï¸âƒ£0ï¸âƒ£ Relocations (Ù„Ùˆ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§ØªØºÙŠØ±)
 Ù„Ùˆ
ImageBase --> Ù…Ø´ Ù…ØªØ§Ø­
#

#Ø§Ù„ÙˆÙŠÙ†Ø¯ÙˆØ²:

    ÙŠÙ†Ù‚Ù„ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬

    ÙŠØµÙ„Ù‘Ø­ Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†

ğŸ“Œ Ø¯Ù‡ Ø¨ÙŠØ­ØµÙ„ ÙƒØªÙŠØ± Ø¨Ø³Ø¨Ø¨ ASLR



#ğŸ§  1ï¸âƒ£1ï¸âƒ£ PE â†’ RAM Lifecycle

[ PE on Disk ]
      â†“
Validate Headers
      â†“
Map Sections
      â†“
Apply Relocations
      â†“
Resolve Imports
      â†“
Set Memory Permissions
      â†“
Jump to Entry Point

#ğŸ§  1ï¸âƒ£2ï¸âƒ£ PE vs In-Memory Execution
#ğŸ“Œ EDR ÙŠÙ‚Ø§Ø±Ù† Ø¯Ù‡
| Ø·Ø¨ÙŠØ¹ÙŠ          | Ù…Ø´Ø¨ÙˆÙ‡                    |
| -------------- | ------------------------ |
| File-backed    | No file                  |
| Sections ÙˆØ§Ø¶Ø­Ø© | Anonymous memory         |
| Valid EP       | Thread start ÙÙŠ Heap     |
| Import Table   | API resolved dynamically |

#ğŸ§© 1ï¸âƒ£3ï¸âƒ£ Visual RAM Mapping of PE
Virtual Memory
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PE Headers (R)              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ .text   (RX)                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ .rdata (R)                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ .data  (RW)                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Heap   (RW)                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Stack  (RW)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

#ğŸ›¡ï¸ 1ï¸âƒ£4ï¸âƒ£ Blue Team / EDR Ø¨ÙŠØ±ÙƒÙ‘Ø² Ø¹Ù„Ù‰:
Entry Point Ù…Ø´ Ø·Ø¨ÙŠØ¹ÙŠ

Sections permissions

Missing Import Table

PE headers ÙÙŠ RAM Ø¨Ø¯ÙˆÙ† File

Modified .text section

#ğŸ§  Ø§Ù„Ø®Ù„Ø§ØµØ© Ø§Ù„Ø°Ù‡Ø¨ÙŠØ©
PE = Blueprint

Ø¨ÙŠÙ‚ÙˆÙ„ Ù„Ù„ÙˆÙŠÙ†Ø¯ÙˆØ²:

Ø­Ù…Ù‘Ù„Ù†ÙŠ Ø¥Ø²Ø§ÙŠ

Ø´ØºÙ‘Ù„Ù†ÙŠ Ù…Ù†ÙŠÙ†

Ø¥Ø¯ÙŠÙ†ÙŠ Ø¥ÙŠÙ‡ ÙÙŠ Ø§Ù„Ø±Ø§Ù…

Ø£ÙŠ ØªÙ†ÙÙŠØ° Ø®Ø§Ø±Ø¬ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¯ÙŠ
= crcsh system
